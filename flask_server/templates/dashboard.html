<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artemis Dashboard - Flask Server</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f0f0f;
            color: #ffffff;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .status-bar {
            background: #1a1a1a;
            padding: 15px 20px;
            display: flex;
            gap: 30px;
            border-bottom: 1px solid #333;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        .status-indicator.offline {
            background: #f44336;
            animation: none;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .container {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: calc(100vh - 140px);
        }

        .sidebar {
            background: #1a1a1a;
            border-right: 1px solid #333;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #667eea;
        }

        .device-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .device-card:hover {
            background: #333;
            border-color: #667eea;
        }

        .device-card.selected {
            border-color: #4caf50;
            background: #333;
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .device-name {
            font-weight: 600;
            color: #ffffff;
        }

        .device-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            background: #4caf50;
            color: white;
        }

        .device-status.offline {
            background: #f44336;
        }

        .device-info {
            font-size: 12px;
            color: #999;
        }

        .map-container {
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            min-width: 250px;
        }

        .map-controls {
            position: absolute;
            top: 20px;
            left: 60px;
            /* To right of zoom controls */
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 1px solid #444;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .control-btn:hover {
            background: #333;
        }

        .control-btn.active {
            background: #4caf50;
            border-color: #4caf50;
        }

        .sensor-data {
            margin-top: 10px;
        }

        .sensor-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 13px;
            border-bottom: 1px solid #333;
        }

        .sensor-label {
            color: #999;
        }

        .sensor-value {
            color: #4caf50;
            font-weight: 600;
        }

        .no-devices {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Custom Pulse Marker */
        .gps-marker-icon {
            background-color: #2196F3;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .gps-marker-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: rgba(33, 150, 243, 0.4);
            animation: gps-pulse 2s infinite;
            z-index: -1;
        }

        .gps-arrow {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 20px solid #f44336;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.3));
            transform-origin: center bottom;
        }

        @keyframes gps-pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.8;
            }

            100% {
                transform: translate(-50%, -50%) scale(4);
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üõ∞Ô∏è Artemis Command Center</h1>
        <p class="subtitle">Real-time GPS & IMU Tracking Dashboard - Flask Server</p>
    </div>

    <div class="status-bar">
        <div class="status-item">
            <div class="status-indicator" id="serverStatus"></div>
            <span>Server: <strong id="serverStatusText">Connecting...</strong></span>
        </div>
        <div class="status-item">
            <span>Active Devices: <strong id="deviceCount">0</strong></span>
        </div>
        <div class="status-item">
            <span>Data Streams: <strong id="streamCount">0</strong></span>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <h2>Connected Devices</h2>
            <div id="deviceList">
                <div class="no-devices">
                    <p>No devices connected</p>
                    <p style="font-size: 12px; margin-top: 10px;">Waiting for devices to register...</p>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>

            <div class="map-controls">
                <button class="control-btn" id="btnFollow" onclick="toggleFollow()">
                    üìç Follow Device
                </button>
                <button class="control-btn" onclick="fitAllDevices()">
                    üîç Fit All
                </button>
            </div>

            <div class="map-overlay" id="deviceDetails" style="display: none;">
                <h3 style="margin-bottom: 10px; color: #667eea;" id="selectedDeviceName">Device Info</h3>
                <div class="sensor-data">
                    <div class="sensor-row">
                        <span class="sensor-label">Device ID:</span>
                        <span class="sensor-value" id="detailDeviceId">-</span>
                    </div>
                    <div class="sensor-row">
                        <span class="sensor-label">Status:</span>
                        <span class="sensor-value" id="detailStatus">-</span>
                    </div>
                    <h4 style="margin: 15px 0 10px; color: #4caf50;">üìç GPS Data</h4>
                    <div class="sensor-row">
                        <span class="sensor-label">Latitude:</span>
                        <span class="sensor-value" id="detailLat">-</span>
                    </div>
                    <div class="sensor-row">
                        <span class="sensor-label">Longitude:</span>
                        <span class="sensor-value" id="detailLon">-</span>
                    </div>
                    <div class="sensor-row">
                        <span class="sensor-label">Altitude:</span>
                        <span class="sensor-value" id="detailAlt">-</span>
                    </div>
                    <div class="sensor-row">
                        <span class="sensor-label">Speed:</span>
                        <span class="sensor-value" id="detailSpeed">-</span>
                    </div>
                    <h4 style="margin: 15px 0 10px; color: #764ba2;">üìä IMU Data</h4>
                    <div class="sensor-row">
                        <span class="sensor-label">Acceleration:</span>
                        <span class="sensor-value" id="detailAccel">-</span>
                    </div>
                    <div class="sensor-row">
                        <span class="sensor-label">Gyroscope:</span>
                        <span class="sensor-value" id="detailGyro">-</span>
                    </div>
                    <div class="sensor-row">
                        <span class="sensor-label">Magnetometer:</span>
                        <span class="sensor-value" id="detailMag">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize map with zoom controls enabled by default
        const map = L.map('map', {
            zoomControl: true,
            scrollWheelZoom: true,
            doubleClickZoom: true
        }).setView([26.8065, 87.2846], 13); // Default to Dharan instead of Kathmandu

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 20
        }).addTo(map);

        const markers = new Map();
        const devices = new Map();
        let selectedDevice = null;
        let followMode = false;
        let hasCenteredMap = false; // Flag to check if we've auto-centered once

        // Previous GPS point for filtering
        const lastPositions = new Map();

        function toggleFollow() {
            followMode = !followMode;
            const btn = document.getElementById('btnFollow');
            if (followMode) {
                btn.classList.add('active');
                if (selectedDevice) {
                    const dev = devices.get(selectedDevice);
                    if (dev && dev.gps) {
                        map.flyTo([dev.gps.lat, dev.gps.lon], 18);
                    }
                }
            } else {
                btn.classList.remove('active');
            }
        }

        function fitAllDevices() {
            followMode = false;
            document.getElementById('btnFollow').classList.remove('active');

            if (markers.size > 0) {
                const group = new L.featureGroup(Array.from(markers.values()));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Initialize Socket.IO
        const socket = io();

        socket.on('connect', () => {
            console.log('Connected to Flask server');
            updateServerStatus(true);
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from Flask server');
            updateServerStatus(false);
        });

        socket.on('active_devices', (data) => {
            data.devices.forEach(device => {
                addOrUpdateDevice(device);
            });
        });

        socket.on('device_registered', (device) => {
            console.log('Device registered:', device);
            addOrUpdateDevice(device);
        });

        socket.on('gps_update', (data) => {
            console.log('GPS update:', data);
            updateDeviceGPS(data.deviceId, data.gps);
        });

        socket.on('imu_update', (data) => {
            console.log('IMU update:', data);
            updateDeviceIMU(data.deviceId, data.imu);
        });

        socket.on('device_disconnected', (data) => {
            console.log('Device disconnected:', data);
            markDeviceOffline(data.deviceId);
        });

        function updateServerStatus(connected) {
            const statusEl = document.getElementById('serverStatus');
            const textEl = document.getElementById('serverStatusText');
            if (connected) {
                statusEl.classList.remove('offline');
                textEl.textContent = 'Connected';
            } else {
                statusEl.classList.add('offline');
                textEl.textContent = 'Disconnected';
            }
        }

        function addOrUpdateDevice(device) {
            devices.set(device.deviceId, device);
            updateDeviceList();
            updateDeviceCount();

            // Setup marker if GPS data is available immediately
            if (device.gps) {
                updateMarker(device.deviceId, device.gps);
            }
        }

        function updateDeviceGPS(deviceId, gps) {
            // Basic validity check
            if (!gps || (gps.lat === 0 && gps.lon === 0)) return;

            // Filter out small jitter
            const lastPos = lastPositions.get(deviceId);
            if (lastPos) {
                // Calculate distance in meters (haversine formula approximation)
                const R = 6371e3; // metres
                const œÜ1 = lastPos.lat * Math.PI / 180;
                const œÜ2 = gps.lat * Math.PI / 180;
                const ŒîœÜ = (gps.lat - lastPos.lat) * Math.PI / 180;
                const ŒîŒª = (gps.lon - lastPos.lon) * Math.PI / 180;

                const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                    Math.cos(œÜ1) * Math.cos(œÜ2) *
                    Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const d = R * c;

                // Ignore movements smaller than 4 meters (jitter)
                // This allows slight changes to update while filtering out stationary noise
                if (d < 4.0) {
                    return;
                }
            }
            lastPositions.set(deviceId, { lat: gps.lat, lon: gps.lon });

            // Auto-center on the first valid GPS fix we receive
            if (!hasCenteredMap) {
                map.setView([gps.lat, gps.lon], 16);
                hasCenteredMap = true;
            }

            const device = devices.get(deviceId);
            if (!device) return;

            device.gps = gps;
            updateMarker(deviceId, gps);

            if (selectedDevice === deviceId) {
                updateDeviceDetails(device);

                // If follow mode is active, center map on this device
                if (followMode) {
                    map.panTo([gps.lat, gps.lon]);
                }
            }
        }

        function updateDeviceIMU(deviceId, imu) {
            const device = devices.get(deviceId);
            if (!device) return;

            device.imu = imu;

            if (selectedDevice === deviceId) {
                updateDeviceDetails(device);
            }
        }

        function markDeviceOffline(deviceId) {
            const device = devices.get(deviceId);
            if (device) {
                device.status = 'offline';
                updateDeviceList();
            }
        }

        function updateMarker(deviceId, gps) {
            // Create a custom div icon
            const customIcon = L.divIcon({
                className: 'custom-gps-marker',
                html: `<div class="gps-marker-icon"><div class="gps-marker-pulse"></div></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            if (markers.has(deviceId)) {
                markers.get(deviceId).setLatLng([gps.lat, gps.lon]);
            } else {
                const marker = L.marker([gps.lat, gps.lon], { icon: customIcon }).addTo(map);
                const device = devices.get(deviceId);
                marker.bindPopup(`<b>${device.username}</b><br>${deviceId}`);
                markers.set(deviceId, marker);

                marker.on('click', () => {
                    selectDevice(deviceId);
                });
            }
        }

        function updateDeviceList() {
            const listEl = document.getElementById('deviceList');

            if (devices.size === 0) {
                listEl.innerHTML = '<div class="no-devices"><p>No devices connected</p></div>';
                return;
            }

            listEl.innerHTML = '';
            devices.forEach((device, deviceId) => {
                const card = document.createElement('div');
                card.className = 'device-card';
                if (selectedDevice === deviceId) {
                    card.classList.add('selected');
                }

                card.innerHTML = `
                    <div class="device-header">
                        <span class="device-name">${device.username}</span>
                        <span class="device-status ${device.status === 'offline' ? 'offline' : ''}">${device.status}</span>
                    </div>
                    <div class="device-info">${deviceId}</div>
                    ${device.gps ? `<div class="device-info">üìç ${device.gps.lat.toFixed(4)}, ${device.gps.lon.toFixed(4)}</div>` : ''}
                `;

                card.onclick = () => selectDevice(deviceId);
                listEl.appendChild(card);
            });
        }

        function selectDevice(deviceId) {
            selectedDevice = deviceId;
            const device = devices.get(deviceId);

            updateDeviceList();
            updateDeviceDetails(device);

            if (device.gps) {
                map.setView([device.gps.lat, device.gps.lon], 15);
            }
        }

        function updateDeviceDetails(device) {
            document.getElementById('deviceDetails').style.display = 'block';
            document.getElementById('selectedDeviceName').textContent = device.username;
            document.getElementById('detailDeviceId').textContent = device.deviceId;
            document.getElementById('detailStatus').textContent = device.status;

            if (device.gps) {
                document.getElementById('detailLat').textContent = device.gps.lat.toFixed(6);
                document.getElementById('detailLon').textContent = device.gps.lon.toFixed(6);
                document.getElementById('detailAlt').textContent = device.gps.alt.toFixed(1) + ' m';
                document.getElementById('detailSpeed').textContent = device.gps.speed.toFixed(1) + ' km/h';
            }

            if (device.imu) {
                const accel = device.imu.accel;
                const gyro = device.imu.gyro;
                const mag = device.imu.mag;

                document.getElementById('detailAccel').textContent =
                    `${accel.x.toFixed(2)}, ${accel.y.toFixed(2)}, ${accel.z.toFixed(2)} m/s¬≤`;
                document.getElementById('detailGyro').textContent =
                    `${gyro.x.toFixed(2)}, ${gyro.y.toFixed(2)}, ${gyro.z.toFixed(2)} ¬∞/s`;
                document.getElementById('detailMag').textContent =
                    `${mag.x.toFixed(1)}, ${mag.y.toFixed(1)}, ${mag.z.toFixed(1)} ¬µT`;
            }
        }

        function updateDeviceCount() {
            document.getElementById('deviceCount').textContent = devices.size;
            const activeCount = Array.from(devices.values()).filter(d => d.status === 'online').length;
            document.getElementById('streamCount').textContent = activeCount;
        }
    </script>
</body>

</html>